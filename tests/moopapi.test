<?php

/*
 * Tests for Moopapi module.
 */

/**
 * Tests that Patchwork library is available, installed and
 * works properly and tests Moopapi interface.
 */
class MoopapiUnitTestCase extends DrupalUnitTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Moopapi unit tests',
      'description' => 'Tests that Patchwork library is available, installed and works properly and tests Moopapi interface.',
      'group' => 'Moopapi',
    );
  }

  public function setUp() {
    parent::setUp(array('moopapi'));
    $library = libraries_detect('patchwork');
    // Check Patchwork library.
    if ($this->assertTrue($library, 'Patchwork library is detected')) {
      if (is_array($library) && !empty($library['installed'])) {
        $this->pass('Patchwork library is installed');
        $library = libraries_load('patchwork');
        $this->assertTrue(!empty($library['loaded']), 'Patchwork library is loaded');
      }
      else {
        $message = 'Error while installing Patchwork library';
        if (!empty($library['error'])) {
          $message = 'Library Patchwork is ' . $library['error'];
        }
        if (!empty($library['error message'])) {
          $message .= ': ' . $library['error message'];
        }
        $this->fail($message);
      }
    }
  }

  public function testMonkeyPatch() {
    // Only now we include necessary file to make Patchwork
    // interception work.
    module_load_include('inc', 'moopapi', 'tests/monkey_patch');
    Patchwork\replace("doesMonkeyPatchWork", function()
    {
        return TRUE;
    });
    $this->assertTrue(doesMonkeyPatchWork(), 'Monkey patching works');
  }

  public function testRegister() {
    $use_cases = array(
      'lowercase',
      'uppercase',
      'camelcase',
      'app_null',
      'class_null',
      'both_null',
    );
    foreach ($use_cases as $use_case) {
      switch ($use_case) {
        // Formatting.
        case 'lowercase':
          $app = 'exampleapp';
          $class = 'exampleclass';
          break;
        case 'uppercase':
          $app = 'EXAMPLEAPP';
          $class = 'EXAMPLECLASS';
          break;
        case 'camelcase':
          $app = 'ExampleApp';
          $class = 'ExampleClass';
          break;
        // Business logic.
        case 'app_null':
          $app = NULL;
          $class = 'ExampleClass';
          break;
        case 'class_null':
          $app = 'ExampleApp';
          $class = NULL;
          break;
        case 'both_null':
          $app = NULL;
          $class = NULL;
          break;
      }
      // Test interface function.
      static $classes;
      $classes_old = $classes;
      $result = moopapi_register($app, $class);
      // Check result.
      if (in_array($use_case, array('lowercase', 'uppercase', 'camelcase', 'class_null'))) {
        // For formatting and class_null use cases.
        $app_capitalized_first = ucfirst(strtolower($app));
        $this->assertTrue(!empty($result[$app_capitalized_first]), "$use_case: Application is registered");
        $class = !empty($class) ? $class : $app;
        $this->assertEqual($result[$app_capitalized_first], ucfirst($class), "$use_case: Application is decorated");
      }
      else {
        // Business logic use cases except class_null.
        $this->assertEqual($classes_old, $classes, "$use_case: Register shouldn't change");
      }
      // Clear workspace.
      unset($result);
      $classes = array();
    }
  }

  public function testWrap() {
    $use_cases = array(
      'lowercase',
      'uppercase',
      'camelcase',
      'class_null',
      'app_absent',
      'class_absent',
      'method_absent',
    );
    foreach ($use_cases as $use_case) {
      switch ($use_case) {
        case 'lowercase':
          $app = 'exampleapp';
          $method = 'examplemethod';
          $class = 'exampleclass';
          break;
        case 'uppercase':
          $app = 'EXAMPLEAPP';
          $method = 'EXAMPLEMETHOD';
          $class = 'EXAMPLECLASS';
          break;
        case 'camelcase':
          $app = 'ExampleApp';
          $method = 'ExampleMethod';
          $class = 'ExampleClass';
          break;
        case 'class_null':
          $app = 'ExampleApp';
          $method = 'exampleMethod';
          $class = NULL;
          break;
        case 'app_absent':
          // @todo Moopapi::absent(): Implement app_absent use case.
          break;
        case 'class_absent':
          // @todo Moopapi::absent(): Implement class_absent use case.
          break;
        case 'method_absent':
          // @todo Moopapi::absent(): Implement method_absent use case.
          break;
      }
      // Test interface function.
      $result = moopapi_wrap($app, $method, $class);
      // Check result.
      if ($use_case === 'class_null') {
        $class = $app;
      }
      $this->assertTrue(is_a($result, $class), "$use_case: Returned Application is of correct class");
      // Clear workspace.
      unset($result);
    }
  }
}

/**
 * It is for testing Moopapi::wrap().
 */
class ExampleApp {
  public function exampleMethod() {}
}

class ExampleClass {
  public function exampleMethod() {}
}
